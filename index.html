<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery Ledger ‚Äì Md Imam</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --bg-light: #f7f7f7; --text-light: #1f2937; --card-light: rgba(255, 255, 255, 0.6); }
        .dark { --bg-dark: #1f2937; --text-dark: #f3f4f6; --card-dark: rgba(55, 65, 81, 0.5); }
        body { font-family: 'Poppins', sans-serif; transition: background-color 0.3s, color 0.3s; background-color: var(--bg-light); color: var(--text-light); }
        .dark body { background-color: var(--bg-dark); color: var(--text-dark); }
        .glass-card { background-color: var(--card-light); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .dark .glass-card { background-color: var(--card-dark); border: 1px solid rgba(75, 85, 99, 0.3); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        .dark input, .dark select { background-color: #374151 !important; border-color: #4b5563 !important; color: #f3f4f6 !important; }
        .session-morning { background-color: rgba(252, 211, 77, 0.2); }
        .session-day { background-color: rgba(96, 165, 250, 0.2); }
        .session-night { background-color: rgba(52, 211, 153, 0.2); }
        #toast-notification { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="mb-6 flex justify-between items-center border-b pb-3">
            <h1 class="text-2xl md:text-3xl font-bold text-indigo-600">Lottery Ledger</h1>
        </header>

        <nav class="flex justify-around bg-white/50 dark:bg-gray-800/50 p-2 rounded-xl shadow-lg mb-6">
            <button onclick="navigate('home')" id="nav-home" class="nav-btn font-semibold py-2 px-4 rounded-lg transition duration-150">üè† Daily Entry</button>
            <button onclick="navigate('report')" id="nav-report" class="nav-btn font-semibold py-2 px-4 rounded-lg transition duration-150">üìä Weekly Report</button>
            <button onclick="navigate('settings')" id="nav-settings" class="nav-btn font-semibold py-2 px-4 rounded-lg transition duration-150">‚öôÔ∏è Settings</button>
        </nav>

        <main id="content-area"></main>

        <div id="toast-notification" class="fixed bottom-5 right-5 z-50 p-3 text-white rounded-lg shadow-xl opacity-0 transform translate-y-4"></div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentPage = 'home';
        let appData = {};
        let settings = { rate: 4.30, developerName: 'Md Imam', theme: 'light' };
        let lastReportDate = new Date().toISOString().split('T')[0];
        const APP_KEY = 'lotteryLedgerData';
        const SETTINGS_KEY = 'lotteryLedgerSettings';
        // --- STEP 1: ADD THIS NEW FONT DATA ---
        const noto_sans_devanagari_base64 = "AAEAAA... (rest of the very long font string is omitted for brevity)"; 
        // Note: A very long string of characters representing the font file goes here.
        // The actual implementation should contain the full Base64 string.

        // --- CORE UTILITIES ---
        const loadSettings = () => { try { const stored = localStorage.getItem(SETTINGS_KEY); if (stored) settings = JSON.parse(stored); document.documentElement.classList.toggle('dark', settings.theme === 'dark'); } catch (e) {} };
        const saveSettings = () => localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        const loadData = () => { try { appData = JSON.parse(localStorage.getItem(APP_KEY)) || {}; } catch (e) { appData = {}; } };
        const saveData = () => { try { localStorage.setItem(APP_KEY, JSON.stringify(appData)); } catch (e) { showToast('Error saving data!', 'red'); } };
        
        // --- DATE & FORMATTING UTILITIES ---
        const toLocalDate = (dateString) => new Date(dateString + 'T00:00:00Z');
        const formatDate = (date) => date.toISOString().split('T')[0];
        const formatToDDMMYYYY = (isoDate) => {
            if (!isoDate) return '';
            const [y, m, d] = isoDate.split('-');
            return `${d}-${m}-${y}`;
        };

        const getMondayOfDate = (dateString) => {
            const date = toLocalDate(dateString);
            const day = date.getDay(); // Sunday: 0, Monday: 1, ..., Saturday: 6
            const diff = date.getDate() - (day === 0 ? 6 : day - 1);
            date.setDate(diff);
            return formatDate(date);
        };

        const getWeekRange = (dateString) => {
            const monday = toLocalDate(getMondayOfDate(dateString));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            return {
                start: formatDate(monday),
                end: formatDate(sunday),
                display: `${formatToDDMMYYYY(formatDate(monday))} to ${formatToDDMMYYYY(formatDate(sunday))}`
            };
        };
        
        const showToast = (message, type = 'green') => {
            const toast = document.getElementById('toast-notification');
            toast.className = 'fixed bottom-5 right-5 z-50 p-3 text-white rounded-lg shadow-xl opacity-0 transform translate-y-4';
            const color = { red: 'bg-red-500', orange: 'bg-orange-500', green: 'bg-green-500' }[type];
            toast.textContent = message;
            toast.classList.add(color, 'opacity-100');
            toast.style.transform = 'translateY(0)';
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.style.transform = 'translateY(1rem)';
            }, 3000);
        };

        // --- DAILY ENTRY PAGE ---
        const renderDailyEntry = (date = formatDate(new Date())) => {
            const selectedDate = date;
            const entry = appData[selectedDate] || { m: {}, d: {}, n: {} };
            const isSettled = appData[getMondayOfDate(selectedDate)]?.settled;
            const sessions = [ { id: 'm', name: 'Morning', color: 'session-morning', data: entry.m }, { id: 'd', name: 'Day', color: 'session-day', data: entry.d }, { id: 'n', name: 'Night', color: 'session-night', data: entry.n } ];
            let html = `<div class="space-y-6"><div class="p-4 glass-card rounded-xl flex items-center justify-between"><label for="date-picker" class="font-medium">Select Date:</label><input type="date" id="date-picker" value="${selectedDate}" onchange="renderDailyEntry(this.value)" class="p-2 border rounded-lg"></div> ${isSettled ? `<p class="p-4 bg-red-100 text-red-700 rounded-lg text-center font-bold">üö´ This week is settled. Entries cannot be changed.</p>` : ''} <form id="daily-entry-form" class="space-y-6"> ${sessions.map(s => `<div class="p-5 glass-card ${s.color} rounded-xl shadow-lg"><h3 class="text-lg font-bold mb-3 border-b pb-2">${s.name}</h3><div class="flex flex-wrap gap-4 mb-4"><div class="flex-1 min-w-[120px]"><label for="${s.id}-in" class="text-sm font-medium">Tickets In</label><input type="number" id="${s.id}-in" value="${s.data.in || ''}" oninput="calculateSessionTotal('${s.id}')" ${isSettled ? 'disabled' : ''} class="p-2 border rounded-lg w-full"></div><div class="flex-1 min-w-[120px]"><label for="${s.id}-return" class="text-sm font-medium">Tickets Return</label><input type="number" id="${s.id}-return" value="${s.data.return || ''}" oninput="calculateSessionTotal('${s.id}')" ${isSettled ? 'disabled' : ''} class="p-2 border rounded-lg w-full"></div></div><div class="flex flex-wrap gap-4 text-sm font-medium pt-3 border-t"><p>Total Tickets: <span id="${s.id}-total" class="font-bold">0</span></p><p>Total Rupees: <span id="${s.id}-rupees" class="font-bold text-green-700 dark:text-green-400">‚Çπ0.00</span></p></div></div>`).join('')} <button type="button" onclick="saveDailyEntry('${selectedDate}')" ${isSettled ? 'disabled' : ''} class="w-full ${appData[selectedDate] ? 'bg-orange-500 hover:bg-orange-600' : 'bg-indigo-500 hover:bg-indigo-600'} text-white font-bold py-3 rounded-xl shadow-lg ${isSettled ? 'opacity-50 cursor-not-allowed' : ''}">${appData[selectedDate] ? 'Update Entry' : 'Save Entry'}</button></form></div>`;
            document.getElementById('content-area').innerHTML = html;
            sessions.forEach(s => calculateSessionTotal(s.id));
        };

        const calculateSessionTotal = (sessionId) => {
            const ticketsIn = parseFloat(document.getElementById(`${sessionId}-in`).value) || 0;
            const ticketsReturn = parseFloat(document.getElementById(`${sessionId}-return`).value) || 0;
            const totalTickets = ticketsIn - ticketsReturn;
            document.getElementById(`${sessionId}-total`).textContent = totalTickets;
            document.getElementById(`${sessionId}-rupees`).textContent = `‚Çπ${(totalTickets * settings.rate).toFixed(2)}`;
        };
        
        const saveDailyEntry = (dateString) => {
            if (appData[getMondayOfDate(dateString)]?.settled) {
                showToast("Cannot save, week is settled.", 'red');
                return;
            }
            let hasData = false;
            const newEntry = { m: {}, d: {}, n: {} };
            ['m', 'd', 'n'].forEach(id => {
                const ticketsIn = parseFloat(document.getElementById(`${id}-in`).value) || 0;
                const ticketsReturn = parseFloat(document.getElementById(`${id}-return`).value) || 0;
                if (ticketsIn > 0 || ticketsReturn > 0) hasData = true;
                newEntry[id] = { in: ticketsIn, return: ticketsReturn };
            });
            
            if (hasData) {
                appData[dateString] = newEntry;
                showToast("Entry saved/updated successfully!", 'green');
            } else {
                delete appData[dateString];
                showToast("Entry was empty and removed.", 'orange');
            }
            saveData();
            renderDailyEntry(dateString);
        };

        // --- WEEKLY REPORT PAGE ---
        const renderWeeklyReport = () => {
            const weekRange = getWeekRange(lastReportDate);
            const isSettled = appData[weekRange.start]?.settled;
            let dateCursor = toLocalDate(weekRange.start);
            let rowsHtml = '';
            let grandTotalRupees = 0;

            for (let i = 0; i < 7; i++) {
                const dateString = formatDate(dateCursor);
                const entry = appData[dateString] || {};
                const dayName = dateCursor.toLocaleDateString('en-US', { weekday: 'short' });
                const mTotal = (entry.m?.in || 0) - (entry.m?.return || 0);
                const dTotal = (entry.d?.in || 0) - (entry.d?.return || 0);
                const nTotal = (entry.n?.in || 0) - (entry.n?.return || 0);
                const dailyRupees = (mTotal + dTotal + nTotal) * settings.rate;
                grandTotalRupees += dailyRupees;
                rowsHtml += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700 text-center"><td class="p-2 font-medium text-left">${formatToDDMMYYYY(dateString)} (${dayName})</td><td class="p-2 session-morning">${entry.m?.in || 0}</td><td class="p-2 session-morning">${entry.m?.return || 0}</td><td class="p-2 font-bold session-morning">${mTotal}</td><td class="p-2 session-day">${entry.d?.in || 0}</td><td class="p-2 session-day">${entry.d?.return || 0}</td><td class="p-2 font-bold session-day">${dTotal}</td><td class="p-2 session-night">${entry.n?.in || 0}</td><td class="p-2 session-night">${entry.n?.return || 0}</td><td class="p-2 font-bold session-night">${nTotal}</td><td class="p-2 font-extrabold text-indigo-700 dark:text-indigo-400">‚Çπ${dailyRupees.toFixed(2)}</td></tr>`;
                dateCursor.setDate(dateCursor.getDate() + 1);
            }
            
            document.getElementById('content-area').innerHTML = `<div class="space-y-6"><h2 class="text-2xl font-bold text-center">Weekly Report ‚Äì ${settings.developerName}</h2><div class="p-4 glass-card rounded-xl flex items-center justify-between"><label for="week-picker" class="font-medium">Select Week:</label><input type="date" id="week-picker" value="${lastReportDate}" onchange="updateReportDate(this.value)" class="p-2 border rounded-lg"></div><div class="p-3 ${isSettled ? 'bg-indigo-100' : 'bg-green-100'} rounded-lg text-center font-bold">${isSettled ? '‚úÖ' : 'üóìÔ∏è'} Week: ${weekRange.display} ${isSettled ? '(Settled)' : ''}</div><div class="overflow-x-auto shadow-xl rounded-xl"><table class="min-w-full text-sm"><thead class="bg-gray-50 dark:bg-gray-700 text-xs uppercase"><tr><th rowspan="2" class="p-2">Date</th><th colspan="3" class="p-2 bg-yellow-300/50">Morning</th><th colspan="3" class="p-2 bg-blue-300/50">Day</th><th colspan="3" class="p-2 bg-green-300/50">Night</th><th rowspan="2" class="p-2">Total ‚Çπ</th></tr><tr><th>In</th><th>Ret</th><th class="font-bold">Total</th><th>In</th><th>Ret</th><th class="font-bold">Total</th><th>In</th><th>Ret</th><th class="font-bold">Total</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">${rowsHtml}</tbody><tfoot><tr class="bg-gray-200 dark:bg-gray-700 font-extrabold border-t-2 border-indigo-500"><td colspan="10" class="p-3 text-right text-lg">Grand Total</td><td class="p-3 text-center text-lg text-red-700 dark:text-red-400">‚Çπ${grandTotalRupees.toFixed(2)}</td></tr></tfoot></table></div><div class="flex gap-4 mt-6"><button onclick="exportWeeklyReportPDF()" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-700">üìÑ Export PDF</button><button onclick="finalizeSettlement('${weekRange.start}')" ${isSettled ? 'disabled' : ''} class="flex-1 ${isSettled ? 'bg-gray-500' : 'bg-green-600 hover:bg-green-700'} text-white font-bold py-3 rounded-xl shadow-lg ${isSettled ? 'cursor-not-allowed' : ''}">${isSettled ? '‚úÖ Settled' : 'üîí Finalize Week'}</button></div></div>`;
        };

        const updateReportDate = (newDate) => {
            lastReportDate = newDate;
            renderWeeklyReport();
        };

        const finalizeSettlement = (mondayDate) => {
            if (appData[mondayDate]?.settled || !confirm(`Finalize this week? Data will be locked.`)) return;
            if (!appData[mondayDate]) appData[mondayDate] = {};
            appData[mondayDate].settled = true;
            saveData();
            showToast("Week settlement finalized!");
            renderWeeklyReport();
        };
        
        // --- PDF EXPORT ---
        const exportWeeklyReportPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            const weekRange = getWeekRange(lastReportDate);
            const body = [];
            let dateCursor = toLocalDate(weekRange.start);
            let grandTotal = 0;

            for (let i = 0; i < 7; i++) {
                const dateString = formatDate(dateCursor);
                const entry = appData[dateString] || {};
                const m = (entry.m?.in || 0) - (entry.m?.return || 0);
                const d = (entry.d?.in || 0) - (entry.d?.return || 0);
                const n = (entry.n?.in || 0) - (entry.n?.return || 0);
                const dailyTotal = (m + d + n) * settings.rate;
                grandTotal += dailyTotal;
                body.push([ `${formatToDDMMYYYY(dateString)} (${dateCursor.toLocaleDateString('en-US', { weekday: 'short' })})`, entry.m?.in || 0, entry.m?.return || 0, m, entry.d?.in || 0, entry.d?.return || 0, d, entry.n?.in || 0, entry.n?.return || 0, n, `Rs. ${dailyTotal.toFixed(2)}` ]);
                dateCursor.setDate(dateCursor.getDate() + 1);
            }
            
            doc.setFontSize(18);
            doc.text('Weekly Ticket Sales Report', doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            doc.setFontSize(11);
            doc.text(`Name: ${settings.developerName}`, 40, 60);
            doc.text(`Week: ${weekRange.display}`, 40, 75);
            doc.autoTable({
                startY: 90,
                head: [['Date', 'Morning In', 'Morning Ret', 'Morning Total', 'Day In', 'Day Ret', 'Day Total', 'Night In', 'Night Ret', 'Night Total', 'Total Rs. ']],
                body: body,
                theme: 'grid',
                headStyles: { fontStyle: 'bold', fillColor: [220, 220, 220], textColor: [0, 0, 0] },
                columnStyles: {
                    1: { fillColor: [253, 244, 212] }, 2: { fillColor: [253, 244, 212] }, 3: { fillColor: [252, 234, 168], fontStyle: 'bold' },
                    4: { fillColor: [219, 234, 254] }, 5: { fillColor: [219, 234, 254] }, 6: { fillColor: [191, 219, 254], fontStyle: 'bold' },
                    7: { fillColor: [209, 250, 229] }, 8: { fillColor: [209, 250, 229] }, 9: { fillColor: [167, 243, 208], fontStyle: 'bold' },
                    10: { fontStyle: 'bold', textColor: [0, 0, 0] }
                },
                foot: [[{ content: 'Grand Total', colSpan: 10, styles: { halign: 'right', fontStyle: 'bold' } }, { content: `Rs. ${grandTotal.toFixed(2)}`, styles: { fontStyle: 'bold' } }]],
            });
            doc.save(`Report_${weekRange.start}.pdf`);
            showToast("PDF report downloading...", 'green');
        };

        // --- SETTINGS PAGE ---
        const renderSettings = () => {
            document.getElementById('content-area').innerHTML = `<div class="space-y-6"><h2 class="text-2xl font-bold text-center">‚öôÔ∏è Settings</h2><div class="p-5 glass-card rounded-xl"><label class="text-lg font-bold mb-2 block">Ticket Rate (‚Çπ)</label><input type="number" value="${settings.rate}" step="0.01" onchange="settings.rate = parseFloat(this.value); saveSettings(); showToast('Rate updated!', 'orange');" class="p-2 border rounded-lg w-full max-w-xs"></div><div class="p-5 glass-card rounded-xl"><label class="text-lg font-bold mb-2 block">Your Name (for Reports)</label><input type="text" value="${settings.developerName}" onchange="settings.developerName = this.value; saveSettings(); showToast('Name updated!', 'orange');" class="p-2 border rounded-lg w-full max-w-xs"></div><div class="p-5 glass-card rounded-xl flex justify-between items-center"><h3 class="text-lg font-bold">Theme</h3><button onclick="toggleTheme()" class="p-2 rounded-lg font-semibold">${settings.theme === 'dark' ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode'}</button></div><div class="p-5 glass-card rounded-xl space-y-4"><h3 class="text-lg font-bold border-b pb-2">Data Management</h3><button onclick="exportDataCSV()" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600">üíæ Export Data (CSV)</button><button onclick="document.getElementById('import-file').click()" class="w-full bg-yellow-500 text-white font-bold py-2 rounded-lg hover:bg-yellow-600">üì• Import Data (CSV)</button><input type="file" id="import-file" accept=".csv" class="hidden" onchange="importDataCSV(event)"><button onclick="clearOldRecords()" class="w-full bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600">üóëÔ∏è Clear Records Older Than 30 Days</button></div></div>`;
        };
        
        const toggleTheme = () => {
            settings.theme = (settings.theme === 'light' ? 'dark' : 'light');
            document.documentElement.classList.toggle('dark', settings.theme === 'dark');
            saveSettings();
            navigate(currentPage);
        };

        const exportDataCSV = () => {
            let csv = 'Date,Session,In,Return,TotalTickets,TotalRupees,Settled\n';
            Object.keys(appData).sort().forEach(date => {
                const entry = appData[date];
                if (!entry.m && !entry.d && !entry.n) return;
                ['m', 'd', 'n'].forEach(key => {
                    const s = entry[key] || {};
                    const total = (s.in || 0) - (s.return || 0);
                    csv += `${date},${key.toUpperCase()},${s.in || 0},${s.return || 0},${total},${(total * settings.rate).toFixed(2)},${appData[getMondayOfDate(date)]?.settled ? 'Yes' : 'No'}\n`;
                });
            });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            link.download = 'lottery_ledger_backup.csv';
            link.click();
            URL.revokeObjectURL(link.href);
            showToast('CSV data exported!');
        };
        
        const importDataCSV = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const lines = e.target.result.split('\n').slice(1); // Skip header
                    lines.forEach(line => {
                        if (!line.trim()) return;
                        const [date, session, ticketsIn, ticketsReturn] = line.split(',');
                        const sessionKey = session.trim().toLowerCase().charAt(0);
                        if (date && ['m', 'd', 'n'].includes(sessionKey)) {
                            if (!appData[date]) appData[date] = {};
                            appData[date][sessionKey] = { in: parseFloat(ticketsIn) || 0, return: parseFloat(ticketsReturn) || 0 };
                        }
                    });
                    saveData();
                    showToast('Data imported successfully!', 'green');
                    navigate('home');
                } catch (err) {
                    showToast('Failed to import CSV. Check file format.', 'red');
                }
            };
            reader.readAsText(file);
        };
        
        const clearOldRecords = () => {
            if (!confirm('Are you sure you want to delete all records older than 30 days? This cannot be undone.')) return;
            const thirtyDaysAgo = formatDate(new Date(new Date().setDate(new Date().getDate() - 30)));
            let clearedCount = 0;
            Object.keys(appData).forEach(date => {
                if (date < thirtyDaysAgo) {
                    delete appData[date];
                    clearedCount++;
                }
            });
            saveData();
            showToast(`${clearedCount} old records have been cleared!`, 'orange');
        };

        // --- NAVIGATION & INITIALIZATION ---
        const navigate = (page) => {
            currentPage = page;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('bg-indigo-500', 'text-white', 'shadow-md'));
            document.getElementById(`nav-${page}`).classList.add('bg-indigo-500', 'text-white', 'shadow-md');
            if (page === 'home') renderDailyEntry();
            else if (page === 'report') renderWeeklyReport();
            else if (page === 'settings') renderSettings();
        };

        window.onload = () => {
            loadSettings();
            loadData();
            navigate('home');
        };
        // Register Service Worker
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
              })
              .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
              });
          });
        };
    </script>
</body>
</html>
